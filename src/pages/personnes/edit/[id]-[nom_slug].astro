---
import Layout from "../../../layouts/Layout.astro";

export const prerender = false;

const { id, nom_slug } = Astro.params;
const isLoggedIn = Astro.locals.pb.authStore.isValid;
const userId = Astro.locals.pb.authStore.model?.id ?? null;

const proffessionOptions = ["acteur", "réalisateur", "scénariste", "producteur"];

const toSlug = (value) =>
  String(value || "personne")
    .normalize("NFKD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)+/g, "");

let personne = null;
let errorMessage = "";

const loadPersonne = async () => {
  if (!id || id === "new") return null;
  return Astro.locals.pb.collection("Personne").getOne(id);
};

if (Astro.request.method === "POST") {
  if (!isLoggedIn) {
    errorMessage = "Vous devez etre connecte pour modifier ou ajouter.";
  } else {
    const data = await Astro.request.formData();
    const intent = String(data.get("intent") || "update");

    const nom = String(data.get("nom") || "").trim();
    const prenom = String(data.get("prenom") || "").trim();
    const dateNaissance = String(data.get("date_de_naissance") || "").trim();
    const dateDeces = String(data.get("date_de_deces") || "").trim();
    const proffession = data.getAll("proffession").map((v) => String(v));

    const payload = {
      nom: nom || null,
      prenom: prenom || null,
      date_de_naissance: dateNaissance || null,
      date_de_deces: dateDeces || null,
      proffession,
      ...(userId ? { user: userId } : {}),
    };

    try {
      if (intent === "create") {
        const record = await Astro.locals.pb.collection("Personne").create(payload);
        const slug = toSlug(nom);
        return Astro.redirect(`/personnes/${record.id}-${slug}`);
      }

      await Astro.locals.pb.collection("Personne").update(id, payload);
      return Astro.redirect(`/personnes/${id}-${nom_slug || "personne"}`);
    } catch (error) {
      if (error instanceof Error) {
        errorMessage = error.message;
      } else {
        errorMessage = "Erreur lors de l'enregistrement.";
      }
    }
  }
}

if (isLoggedIn) {
  try {
    personne = await loadPersonne();
  } catch (error) {
    if (error instanceof Error) {
      errorMessage = error.message;
    } else {
      errorMessage = "Personne introuvable.";
    }
  }
}
---

<Layout>
  <h1>Edition personne</h1>

  {!isLoggedIn && (
    <p>
      Vous devez vous connecter pour modifier ou ajouter.
      <a href="/authpassword">Se connecter</a>
    </p>
  )}

  {errorMessage && <p>{errorMessage}</p>}

  {isLoggedIn && personne && (
    <>
      <h2>Modifier</h2>
      <form method="post">
        <input type="hidden" name="intent" value="update" />

        <label>
          Nom:
          <input type="text" name="nom" value={personne.nom ?? ""} />
        </label>

        <label>
          Prenom:
          <input type="text" name="prenom" value={personne.prenom ?? ""} />
        </label>

        <label>
          Date de naissance:
          <input
            type="date"
            name="date_de_naissance"
            value={personne.date_de_naissance ?? ""}
          />
        </label>

        <label>
          Date de deces:
          <input
            type="date"
            name="date_de_deces"
            value={personne.date_de_deces ?? ""}
          />
        </label>

        <fieldset>
          <legend>Profession</legend>
          {proffessionOptions.map((opt) => (
            <label>
              <input
                type="checkbox"
                name="proffession"
                value={opt}
                checked={personne.proffession?.includes(opt) ?? false}
              />
              {opt}
            </label>
          ))}
        </fieldset>

        <button type="submit">Enregistrer</button>
      </form>
    </>
  )}

  {isLoggedIn && (
    <>
      <h2>Ajouter</h2>
      <form method="post">
        <input type="hidden" name="intent" value="create" />

        <label>
          Nom:
          <input type="text" name="nom" />
        </label>

        <label>
          Prenom:
          <input type="text" name="prenom" />
        </label>

        <label>
          Date de naissance:
          <input type="date" name="date_de_naissance" />
        </label>

        <label>
          Date de deces:
          <input type="date" name="date_de_deces" />
        </label>

        <fieldset>
          <legend>Profession</legend>
          {proffessionOptions.map((opt) => (
            <label>
              <input type="checkbox" name="proffession" value={opt} />
              {opt}
            </label>
          ))}
        </fieldset>

        <button type="submit">Ajouter</button>
      </form>
    </>
  )}

  <p>
    <a href="/personnes">Retour a la liste</a>
  </p>
</Layout>
